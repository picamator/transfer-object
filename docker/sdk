#!/usr/bin/env bash

# function to wrap text in green
function wrap_in_green() {
  echo -e "\e[32m$1\e[0m"
}

# function to wrap text in yellow
function wrap_in_yellow() {
  echo -e "\e[33m$1\e[0m"
}

# function to print a command/option with its description
function print_command() {
  printf "  %-40s %s\n" "$(wrap_in_yellow "$1")" "$2"
}

# function to print an example with its description
function print_example() {
  printf "  %-40s %s\n" "$(wrap_in_yellow "$1")" "$2"
}

# function to display usage
function show_usage() {
  wrap_in_green "==================================="
  wrap_in_green "    Transfer Object (Docker SDK)   "
  wrap_in_green "==================================="
  echo -n "Usage: "
  wrap_in_yellow "$0 [-x] [-p] <command> [args]"
  echo
  echo "Options:"
  print_command "-x" "Enable Xdebug (debug, coverage)"
  print_command "-p" "Enable Xdebug (profile)"
  echo
  echo "Commands:"
  print_command "install" "Install development environment"
  print_command "build" "Build Docker containers"
  print_command "start" "Start Docker containers (honors -x / -p)"
  print_command "stop" "Stop Docker containers"
  print_command "cli [script]" "Open container shell or execute PHP script"
  print_command "composer <cmd>" "Run composer command"
  print_command "phpstan [file]" "Run PHPStan for all project's files or for specified one"
  print_command "phpunit [filter]" "Run PHPUnit tests"
  print_command "phpunit-group [group]" "Run PHPUnit tests by group"
  print_command "phpcs [file]" "Run PHP CodeSniffer for all project's files or for specified one"
  print_command "phpcbf [file]" "Run PHP Code Beautifier and Fixer for all project's files or for specified one"
  print_command "hook-install" "Install CaptainHook"
  print_command "hook [cmd]" "Run CaptainHook command"
  print_command "to-generate [config]" "Generate Transfer Objects from YML definitions"
  print_command "to-generate-bulk [bulk]" "Generate Transfer Objects in bulk from a config list"
  print_command "df-generate" "Generate definition files from JSON blueprints"
  echo
  echo "Examples:"
  print_example "$0 -x start" "Start containers (Xdebug: debug, coverage)"
  print_example "$0 -p start" "Start containers (Xdebug: profile)"
  print_example "$0 composer install" "Run composer install inside container"
}

# vars
DOCKER_CONTAINER_NAME=transfer-object-php
DOCKER_EXEC="docker exec -it ${DOCKER_CONTAINER_NAME}"

# options
XDEBUG_MODE=''

while getopts ":xp" opt; do
  case ${opt} in
    x )
      XDEBUG_MODE="debug,coverage"
      ;;
    p )
      XDEBUG_MODE="profile"
      ;;
    \? )
      show_usage
      exit 1
      ;;
  esac
done
shift $((OPTIND -1))

# arguments
case $1 in
  install)
    $0 build && $0 start && $0 composer install
    ;;
  build)
    USER_ID=$(id -u) GROUP_ID=$(id -g) docker compose build
    ;;
  start)
    if [ "$XDEBUG_MODE" == "" ]; then
      docker compose up -d --remove-orphans
    else
      XDEBUG_MODE=${XDEBUG_MODE} docker compose up -d --remove-orphans
    fi
    ;;
  stop)
    docker compose stop
    ;;
  cli)
    if [ -z "$2" ]; then
      $DOCKER_EXEC bash
    else
      $DOCKER_EXEC php "${@:2}"
    fi
    ;;
  composer)
    $DOCKER_EXEC composer "${@:2}"
    ;;
  phpstan)
    $DOCKER_EXEC composer phpstan "${@:2}"
    ;;
  phpunit)
    if [ -n "$2" ]; then
      $DOCKER_EXEC composer phpunit -- --filter "$2"
    else
      $DOCKER_EXEC composer phpunit
    fi
    ;;
  phpunit-group)
    $DOCKER_EXEC composer phpunit-group "${@:2}"
    ;;
  phpcs)
    $DOCKER_EXEC composer phpcs "${@:2}"
    ;;
  phpcbf)
    $DOCKER_EXEC composer phpcbf "${@:2}"
    ;;
  hook-install)
    $DOCKER_EXEC composer captainhook install --only-enabled --run-mode=docker --run-exec="docker exec -i $DOCKER_CONTAINER_NAME"
    ;;
  hook)
    $DOCKER_EXEC composer captainhook "${@:2}"
    ;;
  to-generate)
    $DOCKER_EXEC composer transfer-generate -- -c "${2:-./config/generator.config.yml}" -v
    ;;
  to-generate-bulk)
    $DOCKER_EXEC composer transfer-generate-bulk -- -b "${2:-./var/config/config.list.txt}"
    ;;
  df-generate)
     $DOCKER_EXEC composer definition-generate
    ;;
  *)
    show_usage
    exit 0
    ;;
esac
